https://medium.com/@quentangle/optimism%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E8%AF%A6%E8%A7%A3-fbc441764425

https://twitter.com/quentangle_

https://research.paradigm.xyz/optimism

https://www.alchemy.com/overviews/optimistic-rollups

https://godorz.info/2022/04/optimism-notes/

https://blog.csdn.net/shangsongwww/article/details/119274785

https://www.cnblogs.com/linguanh/p/16535408.html

![image-20230223162738841](/Users/carver/Library/Application Support/typora-user-images/image-20230223162738841.png)



https://www.helloworld.net/p/0748466805  é‡ç‚¹çœ‹





## ä»€ä¹ˆæ˜¯ä¹è§‚çš„rollup



é“¾å¤–å¤„ç†txns,å¯ä»¥ä»Žä»¥ä¸‹èŠ‚çœï¼š

1. æ•°æ®åŽ‹ç¼©ï¼šä¸€ä¸ªæ‰¹æ¬¡æ‰€å ç”¨çš„ç©ºé—´æ¯”å•ç‹¬çš„txnså †å åœ¨ä¸€èµ·è¦å°‘ã€‚[åŽŸå› ](https://vitalik.ca/general/2021/01/05/rollup.html#how-does-compression-work)

optimism è®¤ä¸ºL2æäº¤ä¸Šæ¥çš„æ–°çŠ¶æ€ï¼ŒL1 æ˜¯ä¸éœ€è¦éªŒè¯çš„ï¼Œå¦‚æžœéªŒè¯ä»–ä¼šæµªè´¹å¾ˆå¤šè®¡ç®—ï¼Œå¤±åŽ»äº†rollupæ„ä¹‰ï¼ˆæ ¸å¿ƒï¼‰

æ‰€ä»¥ä»–ä»¬å°†æ–°æäº¤çš„æ‰¹æ¬¡é”å®šä¸€ä¸ªæ˜ŸæœŸï¼ˆæŒ‘æˆ˜çª—å£æœŸï¼Œè¿™æ˜¯ä¸ªä¼˜åŒ–ç‚¹ï¼Œ1ä¸ªæ˜ŸæœŸå¤ªä¹…äº†ï¼Œä¸ºä»€ä¹ˆæŒ‘æˆ˜æœŸéœ€è¦è¿™ä¹ˆä¹…ðŸš©ï¼‰ï¼Œ ä»»ä½•äººï¼ˆæ— é—¨æ§›ï¼‰å¯ä»¥åœ¨è¿™ä¸ªçª—å£æœŸæäº¤æ•°å­¦è¯æ˜Žï¼Œå¦‚æžœå‘çŽ°äº†æ¬ºè¯ˆå°±å¯ä»¥èŽ·å¾—å¥–åŠ±ï¼ˆæäº¤æ‰¹æ¬¡çš„äººå­˜å…¥çš„é’±ï¼Œå¿…é¡»å­˜æ‰æœ‰èµ„æ ¼æäº¤ï¼‰ï¼Œè‹¥æ˜¯æ²¡æœ‰äº‰è®®ï¼Œå°±æ˜¯æœ€ç»ˆç»“æžœã€‚



## optimism ç»„ä»¶

**L1ï¼š**

- CanonicalTransactionChain
- StateCommitmentChain
- CrossDomainManager

L2ï¼š

- Sequencer (optimism 	)
- batch-submitter
  - å‡ºäºŽ data availability(è¿™é‡Œæ˜¯å¦å¯ä»¥å°è¯•æ›¿æ¢ä¸ºDAè§£å†³æ–¹æ¡ˆðŸš©)ï¼ŒæŠŠäº¤æ˜“æŒ‰æ•²å®šçš„é¡ºåºï¼Œåºåˆ—åŒ–åŽä½œä¸º calldata æäº¤åˆ° L1
- CrossDomainManager

**Data-transport-layer**

ç´¢å¼• L1 äº‹ä»¶ï¼Œå¹¶å­˜å‚¨åˆ°æ•°æ®åº“ä¸­

- TransactionEnqueued
- SequencerBatchAppended
- StateBatchAppended

å¯¹äºŽ L1->L2 äº¤æ˜“ï¼Œè¿˜å°†å»ºç«‹å¼•ç”¨ index <-> queueIndex

Sequencer å‘å®ƒæŸ¥è¯¢å¾…æ‰§è¡Œçš„ L1->L2 äº¤æ˜“

**realyer:**

å®žæ—¶ç›‘æŽ§å·²è¿‡æŒ‘æˆ˜æœŸçš„ L2->L1 äº¤æ˜“ï¼Œåœ¨ L1 ä¸Šè°ƒç”¨åˆçº¦å®Œæˆä¸­ç»§ ,æœªæ‰¾åˆ°ä»£ç ðŸš©

## optimism åˆçº¦ç»„æˆ


### L1å’ŒL2ç§»åŠ¨èµ„é‡‘çš„åŒå‘æ¡¥æ¢

===========L1 bridge

===========L2 bridge

> åŽŸç†ï¼šé”å®šL1çš„èµ„é‡‘ï¼Œå¹¶åœ¨L2ä¸Šé“¸é€ ç­‰å€¼èµ„é‡‘ã€‚æå–èµ„é‡‘æ—¶ï¼Œæ¡¥è¦çƒ§æŽ‰L2çš„èµ„é‡‘å¹¶é‡Šæ”¾é”å®šçš„L1èµ„é‡‘

### è·¨åŸŸä¿¡æ¯ä¼ é€’

L1å’ŒL2ä¹‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡ä¸€ä¸ªè·¨åŸŸä¿¡ä½¿åˆçº¦è¿›è¡Œçš„ï¼ˆL1ã€L2ä¸Šéƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼‰ã€‚åœ¨å†…éƒ¨è¿™ä¸ªåˆçº¦å­˜å‚¨æ¶ˆæ¯ï¼Œå¹¶ä¾é  â€œä¸­ç»§å™¨relayersâ€æ¥é€šçŸ¥å¦ä¸€ä¸ªé“¾ï¼ˆL1æˆ–L2ï¼‰æœ‰æ–°æ¶ˆæ¯

> ä¸å­˜åœ¨åŽŸç”Ÿçš„L1-><-é€šä¿¡ï¼Œæ¯ä¸€æ–¹éƒ½æœ‰relayMessageè¿™æ ·çš„å‡½æ•°ï¼Œ *ä¸­ç»§å™¨åº”è¯¥ä½¿ç”¨ä¼ ç»Ÿçš„web2 HTTPæ¥è°ƒç”¨å®ƒä»¬*

### å¤„ç†äº¤æ˜“å¹¶rollup

å…¶è§’è‰²æ˜¯sequencerï¼ˆç›®å‰æ˜¯ä¸­å¿ƒåŒ–çš„ï¼ŒåŽ»ä¸­å¿ƒåŒ–æˆ–è€…åˆ†å¸ƒå¼çš„åº”è¯¥æ›´å¥½ï¼Œé¿å…å•ç‚¹æ•…éšœé—®é¢˜ðŸš©ï¼‰ ï¼Œä¸»è¦ä»£ç å°±æ˜¯L2Gethï¼Œ ä»–å°±æ˜¯ä¸“é—¨æŽ¥æ”¶L2äº¤æ˜“ã€‚å°†çŠ¶æ€æ›´æ–°ä½œä¸ºä¸€ä¸ªå¾…å®šåŒºå—åº”ç”¨åˆ°å…¶æœ¬åœ°çŠ¶æ€ã€‚è¿™äº›å¾…å¤„ç†åŒºå—ä¼šå®šæœŸå¤§æ‰¹é‡åœ°æäº¤ç»™ä»¥å¤ªåŠï¼ˆL1ä¸Šçš„è§„èŒƒé“¾åˆçº¦ï¼‰è¿›è¡Œæœ€ç»ˆå¤„ç†ã€‚

åœ¨ä»¥å¤ªåŠä¸ŠæŽ¥å—è¿™äº›æ‰¹æ¬¡çš„åŠŸèƒ½æ˜¯`appendSequencerBatch`ï¼Œè¿™æ˜¯L1ä¸Š`CanonicalTransactionChain`åˆçº¦çš„ä¸€éƒ¨åˆ†ã€‚åœ¨å†…éƒ¨ï¼Œ`appendSequencerBatch`ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°æ¥å¤„ç†æ‰¹æ¬¡ã€‚ä»–ä¼šå­˜å‚¨æ‰¹é‡äº¤æ˜“ï¼Œè¿™ä¸ªé‡Œé¢çš„æ•°æ®æ˜¯åŽé¢å¤„ç†äº‰ç«¯çš„è¯æ˜Žæ•°æ®ï¼Œéœ€è¦ç†è§£ä¸‹æ€Žä¹ˆå·¥ä½œçš„ðŸš©



### å¤„ç†çº çº·çš„çŠ¶æ€æ›´æ–°

äº‰ç«¯çš„å·¥ä½œæ–¹å¼æ˜¯æäº¤ä¸€ä¸ªçŠ¶æ€æ›´æ–°æ— æ•ˆçš„è¯æ˜Žï¼Œå¹¶æ ¹æ®å­˜å‚¨çš„çŠ¶æ€æ›´æ–°ï¼ˆå­˜å‚¨çš„æ‰¹æ¬¡å…ƒæ•°æ®ï¼šå“ˆå¸Œå’Œä¸Šä¸‹æ–‡ï¼‰éªŒè¯è¿™ä¸ªè¯æ˜Žã€‚

è´Ÿè´£å¤„ç†çº çº·çš„åˆçº¦æ˜¯`OVMFraudVerifier`ã€‚è¯¥åˆçº¦æ˜¯OVM â€” Optimismè™šæ‹Ÿæœºï¼ˆç±»ä¼¼äºŽEVM â€” Ethereumè™šæ‹Ÿæœºï¼‰çš„ä¸€éƒ¨åˆ†

è¿™ä¸ªåˆçº¦æˆ‘å¹¶æ²¡æœ‰æœåˆ°

```GO
contract OVM_FraudVerifier is Lib_AddressResolver, OVM_FraudContributor, iOVM_FraudVerifier {
    /**
     * æœ€ç»ˆå®Œæˆæ¬ºè¯ˆéªŒè¯è¿‡ç¨‹ã€‚
     * @param _preStateRoot æ¬ºè¯ˆäº¤æ˜“å‰çš„çŠ¶æ€æ ¹ã€‚
     * @param _preStateRootBatchHeader æ‰€æä¾›çš„å‰çŠ¶æ€æ ¹çš„æ‰¹æ¬¡å¤´ã€‚
     * @param _preStateRootProof ä¸ºæ‰€æä¾›çš„å‰çŠ¶æ€æ ¹çš„åŒ…å®¹è¯æ˜Žã€‚
     * @param _txHash çŠ¶æ€æ ¹çš„äº¤æ˜“
     * @param _postStateRoot æ¬ºè¯ˆæ€§äº¤æ˜“åŽçš„çŠ¶æ€æ ¹ã€‚
     * @param _postStateRootBatchHeader æ‰€æä¾›çš„åŽçŠ¶æ€æ ¹çš„æ‰¹æ¬¡å¤´ã€‚
     * @param _postStateRootProof ä¸ºæ‰€æä¾›çš„åŽçŠ¶æ€æ ¹çš„åŒ…å®¹è¯æ˜Žã€‚
     */
    function finalizeFraudVerification(
        bytes32 _preStateRoot,
        Lib_OVMCodec.ChainBatchHeader memory _preStateRootBatchHeader,
        Lib_OVMCodec.ChainInclusionProof memory _preStateRootProof,
        bytes32 _txHash,
        bytes32 _postStateRoot,
        Lib_OVMCodec.ChainBatchHeader memory _postStateRootBatchHeader,
        Lib_OVMCodec.ChainInclusionProof memory _postStateRootProof
    )
        override
        public
        contributesToFraudProof(_preStateRoot, _txHash)
    {
        iOVM_StateTransitioner transitioner = getStateTransitioner(_preStateRoot, _txHash);
        
        // ... a bunch of require statements omitted

        // If the post state root did not match, then there was fraud and we should delete the batch
        require(
            _postStateRoot != transitioner.getPostStateRoot(),
            "State transition has not been proven fraudulent."
        );
        
        _cancelStateTransition(_postStateRootBatchHeader, _preStateRoot);

        // TEMPORARY: Remove the transitioner; for minnet.
        transitioners[keccak256(abi.encodePacked(_preStateRoot, _txHash))] = iOVM_StateTransitioner(0x0000000000000000000000000000000000000000);

        emit FraudProofFinalized(
            _preStateRoot,
            _preStateRootProof.index,
            _txHash,
            msg.sender
        );
    }
    
    /**
     * ä»ŽçŠ¶æ€æ‰¿è¯ºé“¾ä¸­åˆ é™¤ä¸€ä¸ªçŠ¶æ€è½¬æ¢ã€‚
     * @param _postStateRootBatchHeader åŽçŠ¶æ€æ ¹çš„å¤´ã€‚
     * @param _preStateRoot å‰çŠ¶æ€æ ¹çš„å“ˆå¸Œå€¼ã€‚
     */
    function _cancelStateTransition(
        Lib_OVMCodec.ChainBatchHeader memory _postStateRootBatchHeader,
        bytes32 _preStateRoot
    )
        internal
    {
        iOVM_StateCommitmentChain ovmStateCommitmentChain = iOVM_StateCommitmentChain(resolve("OVM_StateCommitmentChain"));
        iOVM_BondManager ovmBondManager = iOVM_BondManager(resolve("OVM_BondManager"));

        // Delete the state batch.
        ovmStateCommitmentChain.deleteStateBatch(
            _postStateRootBatchHeader
        );

        // Get the timestamp and publisher for that block.
        (uint256 timestamp, address publisher) = abi.decode(_postStateRootBatchHeader.extraData, (uint256, address));

        // Slash the bonds at the bond manager.
        ovmBondManager.finalize(
            _preStateRoot,
            publisher,
            timestamp
        );
    }
}
```

- `finalizeFraudVerification`æ£€æŸ¥`_postStateRoot`ï¼ˆç”±éªŒè¯è€…æäº¤ï¼‰æ˜¯å¦ä¸ŽæŽ’åºå™¨æäº¤çš„rootä¸ä¸€è‡´ã€‚
- å¦‚æžœä¸ä¸€è‡´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åœ¨`_cancelStateTransition`ä¸­åˆ é™¤è¯¥æ‰¹æ¬¡ï¼Œå¹¶å‰Šå‡æŽ’åºè€…çš„å­˜æ¬¾ï¼ˆä¸ºäº†æˆä¸ºä¸€ä¸ªæŽ’åºå™¨ï¼Œä½ éœ€è¦é”å®šä¸€ä¸ªå­˜æ¬¾ã€‚å½“ä½ æäº¤ä¸€ä¸ªæ¬ºè¯ˆæ€§çš„æ‰¹æ¬¡æ—¶ï¼Œä½ çš„æŠ¼é‡‘å°±ä¼šè¢«å‰Šå‡ï¼Œè¿™äº›é’±å°±ä¼šç»™éªŒè¯è€…ï¼Œä½œä¸ºä¿æŒæ•´ä¸ªæœºåˆ¶è¿è¡Œçš„æ¿€åŠ±ï¼‰ã€‚

## rollupäº¤æ˜“



## æ¬ºè¯ˆè¯æ˜Ž



## OVM



## å‚è€ƒ
