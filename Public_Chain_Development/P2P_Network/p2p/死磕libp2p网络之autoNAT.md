

## # 什么是Nats

当流量在网络边界之间移动时，很常见的一个过程是网络地址转换。网络地址转换（NAT）将**一个地址**从**一个地址空间**映射到**另一个地址空间**。

**NAT允许多台计算机共享一个公共地址**，这对于IPv4协议的持续运行至关重要。否则，IPv4协议的32位地址空间将无法满足现代网络人口的需求。

例如，当我连接到家庭wifi时，我的计算机会得到一个IPv4地址10.0.1.15。这是为私有网络保留的IP地址范围之一。当我发起对公共IP地址的外部连接时，**路由器会将我的内部IP替换为它自己的公共IP地址**。**当数据从另一端回来时，路由器会再次将其转换回内部地址**。

虽然对于外发连接来说，NAT通常是透明的，但监听传入连接需要一些配置。**路由器只监听一个公共IP地址**，但内部网络中的任意数量的机器都可能处理请求。为了提供服务，您的**路由器必须被配置为将某些流量发送到特定的机器**，通常是通过**将一个或多个TCP或UDP端口从公共IP映射到内部IP**。

虽然手动配置路由器通常是可能的，但并不是每个想要运行点对点应用程序或其他网络服务的人都有这样的能力。

我们希望libp2p应用程序可以在任何地方运行，不仅仅限于数据中心或具有稳定公共IP地址的机器。为了实现这一点，以下是在libp2p中可用的NAT穿透的主要方法。

## 自动路由器配置
许多路由器支持自动配置协议进行端口转发，最常见的是UPnP或nat-pmp。

如果您的路由器支持这些协议之一，libp2p将**尝试自动配置一个端口映射**，以允许其监听传入流量。如果网络和libp2p实现支持，这通常是最简单的选择。

## 什么是AutoNAT？
AutoNAT允许节点请求其他节点拨打其所认为的公共地址。

对于位于NAT后面的私有节点，强烈建议:

- 不要公布私有地址

- 通过中继获得预订，以改善与公共网络的连接，并发布中继地址。

对于公共节点，建议：

- 启动中继以协助其他节点
- 考虑**激活DHT服务器模式**以改善与公共网络的连接。
  如果大多数此类拨号尝试成功，则节点可以相当确定它没有在NAT后面。另一方面，如果大多数这些拨号尝试失败，则强烈表明NAT正在阻止传入连接。

要启动协议，节点向另一个节点发送一个Dial消息，其中包含多个地址列表。然后，节点使用与其常规libp2p连接不同的IP和节点ID尝试拨打这些地址。如果至少有一个拨号成功，则对方节点向请求节点发送一个带有ResponseStatus: SUCCESS的DialResponse消息。

如果所有拨号都失败，则对方节点将发送一个带有ResponseStatus: E_DIAL_ERROR的DialResponse消息。请求节点可以使用对等方的响应来确定它是否在NAT后面。

如果响应指示成功，则该节点很可能不在NAT后面，无需使用中继服务器来改善其连接。如果响应指示错误，则该节点很可能在NAT后面，可能需要使用中继服务器与网络中的其他节点进行通信。

为了防止某些类型的攻击，AutoNAT的libp2p实现不能拨打未基于请求节点的IP地址的任何多地址，并且不能通过中继连接接受拨号请求（因为不可能验证通过中继连接到达的节点的IP地址）。

这是为了防止放大攻击，在此攻击中，攻击者向许多客户端提供指向目标的相同的虚假映射地址，导致所有流量集中在目标上
