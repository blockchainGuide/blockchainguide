# circuit relay 是什么

电路继电器是一种传输协议，可通过第三方“中继”对等方在两个peer之间的流量路由。

在许多情况下，peers将无法以使他们公开访问的方式穿越其NAT和/或防火墙。或者他们可能不会共享可以直接交流的通用传输协议。

为了在NAT（例如NAT）等连接障碍物面前启用对等体系结构，Libp2p定义了一种称为P2P-Circuit的协议。当peer无法在公共地址上收听时，它可以拨打到relay peer，这将保持长期的连接。其他同行将能够使用P2P-circuit地址拨打relay peer，该地址将转发到其目的地。

中继协议的一个重要方面是它不是“透明的”。换句话说，源和目的地都知道流量正在被中继。这很有用，因为目的地可以看到用于打开连接的中继地址，并可能使用它来构造返回源的路径。它也不是匿名的——所有参与者都使用他们的对等ID进行识别，包括中继节点。

## 中继地址

中继电路是使用多地址识别的，该多地址包括其流量正**在被中继的对等体**（侦听对等体或“中继目标”）的对等体ID。

假设我有一个对等体ID为QmAlice。我想把我的地址发给我的朋友QmBob，但我的NAT不允许任何人直接拨我。

我能构造的最基本的p2p电路地址如下所示：

```markdown
/p2p-circuit/p2p/QmAlice
```

上面的地址很有趣，因为它不包括我们想要联系的对等点（QmAlice）或将传送流量的中继对等点的任何传输地址。如果没有这些信息，同伴给我打电话的唯一机会就是发现中继，并希望他们能与我建立联系。

一个更好的地址应该是/p2p/QmRelay/p2p-circuit/p2p/QmAlice。这包括特定中继对等体QmRelay的标识。如果对等方已经知道如何打开与QmRelay的连接，他们将能够联系到我们。

更好的做法是在地址中包含中继对等方的传输地址。比方说，我已经用对等ID QmRelay建立了到特定中继的连接。他们通过识别协议告诉我，他们正在侦听IPv4地址为198.51.100.0的55555端口上的TCP连接。我可以构建一个地址，描述通过该传输的特定中继到我的路径：

```markdown
/ip4/198.51.100.0/tcp/55555/p2p/QmRelay/p2p-circuit/p2p/QmAlice
```

在/p2p-circuit/上面之前的所有内容都是中继对等体的地址，其中包括传输地址和它们的对等体ID QmRelay。在/pp-circuit/之后是线路另一端我的对等端的对等端ID，QmAlice。

通过将完整的中继路径提供给我的朋友QmBob，他们能够快速建立中继连接，而不必“四处打听”有通往QmAlice的中继。

## 中继过程

![Circuit v2 Protocol Interaction](https://raw.githubusercontent.com/libp2p/specs/master/relay/circuit-v2.svg)

1. 节点A位于NAT和/或防火墙后面，例如通过AutoNAT服务检测到的。

2. 因此，节点A请求与中继器R进行预约。即，节点A要求中继器R代表其监听传入连接。

3. 节点B想要建立到节点a的连接。假设节点a不通告任何直接地址，而只通告中继地址，节点B连接到中继R，要求中继R中继到a的连接。

4. 中继R将连接请求转发到节点A，并最终中继A和B发送的所有数据