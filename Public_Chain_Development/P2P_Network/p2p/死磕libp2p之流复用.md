# 流复用

libp2p是基于流抽象构建的，并使用**双向消息流**在节点之间发送数据。然而，仅依赖两个节点之间的单个消息流可能会导致可扩展性问题和瓶颈。每个连接的两端的节点可能会运行多个应用程序，通过流发送和等待数据。单个流会阻塞彼此间的应用程序，因为一个应用程序需要等待另一个应用程序完成利用流后才能发送和接收自己的消息。

为解决这个问题，libp2p允许应用程序使用流多路复用。**多路复用允许在单个连接中创建多个“虚拟”连接**。这使节点可以通过单独的虚拟连接发送多个流的消息，提供可扩展的解决方案，消除单个流创建的瓶颈。**两个libp2p节点可以有一个TCP连接，并使用不同的端口号来区分流**。然后像IPFS使用的Kademlia或GossipSub这样的不同应用程序/进程会获得自己的数据流，使传输更有效。流多路复用使得运行在libp2p之上的应用程序或协议认为它们是运行在该连接之上的唯一实例。另一个例子是HTTP/2将流引入了HTTP中，允许在同一个连接上并行执行多个HTTP请求。

综上所述，流复用可以被用于在libp2p之上的应用程序之间共享单个连接，提供更有效的解决方案，特别是在建立连接开销很大时，例如需要进行NAT打洞时。通过仅建立一次连接并通过同一连接运行多个流，libp2p可以减少与频繁建立连接相关的资源开销和延迟惩罚。

## libp2p中的流复用器

流连接多路复用器是libp2p栈的关键组件，为节点提供可插拔的多路复用功能。libp2p主机可以**同时支持多个多路复用器**，并且节点之间在初始连接握手期间协商多路复用器的选择。此协商协议允许libp2p在未来采用新的多路复用器并保持向后兼容性与现有多路复用器。

💡
对于构建libp2p应用程序的开发人员，与流连接多路复用器的交互通常仅限于初始配置阶段。libp2p栈自动处理多路复用器的协商和设置，确保所有连接都是流多路复用的，并允许在单个连接上无缝传输多个流的数据。

当前，libp2p支持两个流连接多路复用器，即mplex和yamux。然而，libp2p栈中可用的许多传输协议都具有本地流连接，例如QUIC，WebTransport和WebRTC，在这些情况下，libp2p不需要执行流多路复用，因为协议已经提供了它。

# Switch

libp2p通过名为交换机（或“swarm”（根据实现不同））的组件**维护关于已知节点和现有连接的一些状态**。 该交换机提供了一种拨号和监听接口，用于抽象给定连接所使用的流多路复用器的详细信息。

在配置libp2p时，应用程序启用流多路复用模块，当拨号节点并监听连接时，交换机将使用这些模块。如果远程节点支持任何相同的流多路复用器实现，则在建立连接时交换机将选择并使用它。如果您拨打交换机已经存在的一个已经打开的连接的节点，新的数据流将自动启用现有连接进行多路复用。

在连接建立过程的早期阶段，就会协商选用哪种流多路复用器。节点使用协议协商来协商共同支持的多路复用器，该多路复用器将“原始”传输连接升级为能够打开新流的复用连接。

# mplex

mplex是libp2p早期设计的一个简单的流连接多路复用器。它是一个简单的协议，不提供其他流连接多路复用器提供的许多功能。值得注意的是，**mplex不提供流量控制，这是现在被认为是流连接多路复用器的关键功能之一**。

mplex在两个对等方之间的可靠、有序的通道上运行，例如TCP连接。对等方可以打开、写入、关闭和重置一个流。mplex使用像yamux一样的基于消息的编帧层，使其能够复用不同的数据流，包括面向流的数据和其他类型的消息。

缺点：
mplex没有任何流量控制。

Backpressure是一种机制，用于防止一个节点压垮耗时的数据的接收端。

mplex也不限制节点可以打开的数据流的数量。

在libp2p中应该使用Yamux而不是mplex。因为Yamux本身支持流量控制，所以更适用于需要传输大量数据的应用程序。

直到最近，mplex仍然受到支持的原因是与没有yamux支持的js-libp2p兼容。现在js-libp2p已经具备了yamux支持，所以仅应使用mplex来提供向遗留节点提供向后兼容性。

# Yamux

Yamux（又一个多路复用器）是libp2p中使用的强大的流连接多路复用器。它最初由Hashicorp为Go开发，现在在Rust、JavaScript和其他语言中实现。 它在**单个TCP连接上允许多个并行数据流**。它的设计灵感来自SPDY（后来成为HTTP / 2的基础），但它与它不兼容。

Yamux的关键特性之一是其支持通过**背压进行流量控制**。该机制用于在数据发送方和接收方之间协调数据传输速度的方法。当数据发送方发送数据的速度超过接收方处理数据的速度时，就会发生背压。接收者可以发送一个信号给发送方，表示它无法快速处理所有数据，并请求发送方减慢数据的发送速度。这种机制可以防止接收器被淹没并导致数据丢失，同时可以尽可能地提高数据吞吐量。这种机制在许多网络应用程序的设计中是至关重要的，因为它有助于保持网络流畅并防止资源浪费

**在libp2p中应该使用Yamux而不是mplex，因为mplex不提供在流程级别上应用背压的机制。**