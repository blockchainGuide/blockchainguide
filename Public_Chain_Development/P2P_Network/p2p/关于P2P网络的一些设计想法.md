1. 需要设置与本节点连接的数目，一般20-25 

2. 种子节点，一般是将所有已知网络地址配置为种子节点

3. 节点连接淘汰策略（1 Random, 2 FIFO, 3 LIFO）

4. TLS 认证配置

5. 黑名单和白名单的设置

6. 消息发送的一个优先级设置，比如说共识消息优先（0-10级）

7. 大消息体拆包，组包（将消息体拆解成256个小包，再组合）

8. 支持的一般协议包括，TCP，QUIC

9. 需要支持多连接复用并行发送（与每个节点建立多个连接，可以发送多个消息）

10. 中继转发

    ![image-20221024103004301](https://tva1.sinaimg.cn/large/008vxvgGgy1h7g67mdy8sj31cq0u0q55.jpg)

在这种场景下，如果不采用Relay或者NAT穿透功能的话，虽然node1和node2之间可以建立连接，但是node1与node3，node1与node4之间并不能打通进行直接通信。当我们启用中继功能，配置中继地址的话，就可以通过node2作为媒介，将**node1<—>node3**，**node1<—>node4**建立。具体配置如下

11. nAT穿透
12. 传输层之上运用加密协议noise
13. 支持多路复用协议yamux
14. 业务层协议
    - 区块同步协议
    - gossip
    - 交易协议
15. mdns启用
16. kad协议









-------------

++++++++++++++++++++



# network

1. 支持节点之间进行连接
2. 支持节点ping pong
3. 支持节点互连
4. 支持节点发现
5. 支持bootnode节点

## 连接管理

- 两种节点角色，后期可以扩展，目前就是验证节点和普通节点
- 添加连接，当连接满50的时候，要求添加优先级高的连接
- 最大连接50
- 删除连接
- 如果连接关闭，则从连接映射表中删除连接
- 要将上述的功能嵌入到Network().Notify中
- 支持每10分钟刷新路由表，替换普通节点为验证节点
- 支持不同的多路复用流处理
- 支持验证节点之间通过yamux 传递共识消息，普通节点之间只能传输同步区块消息

## 各种对象关系

1. 主机之间可以建立连接
2. 主机之间建立连接的方式有多种，支持tcp ,udp,quic ,所以要求主机在不同类型的地址上监听
3. 网络实例， 一个连接就可以看作一个网络实例
4. 连接和流之间的关系
   - 1个连接可以多个流，每个流对应一个协议ID，但是一个流只能属于一个连接
   - 通常做法使用流来传输应用层协议，而不是直接使用连接
5. mplex 和yamux 的用法以及分别有什么用
6. webRTC的支持 （主要是隐私性和安全性）

## 程序逻辑

1. 启动host
2. 创建conn manager
3. 创建stream handler
4. 注册stream handler
5. 注册 广播消息处理器
6. 启动conn manager
7. 启动stream manger
8. 注册连接处理事件通知

还差bootstraps 

节点发现

和消息发布订阅
pubsub 处理共识消息 
gossipsub 处理同步消息

pubsub或者gossipsub用来处理共识消息，广播区块交易消息

同步消息使用多路复用流来处理， 涉及到交互，并不需要大量gossip
交易的广播可以使用gossipsub进行传播，但如果想要确保交易在网络中的可靠传输，使用数据流可能更好。数据流可以提供双向通信，并能够确保每个交易的到达和确认，这在需要进行一些协商和交互的情况下特别有用，例如交易池的维护和交易验证等。此外，使用数据流还可以实现更复杂的交易处理逻辑，例如可以将交易按照优先级或其他规则进行排序和选择处理。因此，在一些对交易的可靠传输和处理有更高要求的场景下，使用数据流可能更适合

需要限制每个节点转发的消息数量 PeerScoreParams 

可以在建立连接时就创建好多路复用流并保存在连接信息中，然后在发送共识消息时直接使用已有的多路复用流。这样可以减少重复创建流的开销

多路复用流还可以通过优先级来选择处理哪些流，从而实现更加灵活的流控制，最好加上时间戳，来保证流不会只处理优先级高的
noise协议可以用于建立安全的点对点通信连接。当两个节点尝试建立连接时，它们会交换各自的公钥，并使用这些公钥来生成一个共享密钥。然后，它们会使用这个共享密钥来加密所有传输的数据，并确保只有授权的节点可以解密和访问这些数据。

在使用libp2p构建应用程序时，可以通过使用noise协议来确保节点之间的安全通信，防止中间人攻击和其他安全问题，TLS协议实际适合在联盟链，那种web server client 模式中



dcutr是一种基于流量控制和拓扑感知的流量路由协议，可以在libp2p网络中实现高效的数据传输。

在传统的p2p网络中，节点通常采用无差别的转发策略，即任何接收到的数据都会被立即转发给其他节点。这种策略容易导致网络拥塞和资源浪费，影响网络的性能和稳定性。

而dcutr则可以根据网络拓扑结构和节点的资源状况来动态调整流量路由，实现有效的流量控制和拓扑感知。具体来说，dcutr可以通过以下几个步骤实现：

拓扑感知：节点会定期向其他节点发送PING消息，以获取节点之间的拓扑关系和网络状况信息。

流量控制：节点会根据接收到的PING消息和自身的资源状况，决定是否接收和转发数据。

动态路由：节点可以根据接收到的PING消息和流量控制信息，动态调整数据传输的路由路径，以避免网络拥塞和资源浪费。

总的来说，dcutr可以优化节点之间的数据传输，提高网络性能和稳定性，特别适用于高流量和高负载的场景。


nats和auto nat都是libp2p提供的NAT穿透的解决方案。

区别在于，nats需要一个外部的NATS服务器来协助进行NAT穿透，而auto nat则是使用一种称为“UPnP”（Universal Plug and Play）的协议来自动穿透NAT。当您使用auto nat时，libp2p将自动检测您所连接的网络，并尝试在网络设备上自动打开端口以进行通信。 如果UPnP不可用，则自动尝试NAT穿透。

总体来说，如果您使用的网络设备支持UPnP，则使用auto nat会更简单和方便。如果您没有UPnP，或者您的网络环境比较复杂，则使用nats可能更可靠一些。

autoNAT 会尝试使用一系列的 NAT 穿透技巧来穿透 NAT，包括 UPnP、NAT-PMP 和 Port Control Protocol (PCP)。不过，并不是所有的 NAT 设备都支持这些穿透技巧，autoNAT 也无法穿透一些特定的网络环境，比如 CGNAT（Carrier-Grade NAT）等，所以不能保证 100% 成功。如果需要更稳定的 NAT 穿透，可以使用 libp2p 中的 Circuit Relay 服务， 默认情况下，realy





应用协议管理
节点信息管理
连接管理
数据流管理
组播  pubsub 订阅
节点发现
节点路由
节点中继
节点nat 

安全传输 tcp udp quic  

## 网络设计目标
### 节点发现与连接管理
节点发现与连接管理：

使用libp2p中的Peerstore存储已知的节点信息，包括节点ID、公钥、地址等。
使用libp2p中的Discovery模块进行节点发现。可以使用Bootstrap节点，MDNS发现或其他发现协议如Kademlia DHT自身的节点发现功能。
设计连接管理策略，如根据**节点性能、延迟、信誉等指标选择对等节点进行连接**。可以使用libp2p中的ConnManager进行连接管理。

传输协议管理：

使用libp2p中的多种传输协议，如TCP、UDP、QUIC等。可以使用libp2p的Transport接口进行传输协议的封装和管理。
实现传输协议升级和协商机制，允许节点在连接时协商最佳的传输协议。
使用流多路复用技术，如Yamux或Mplex，允许在单个连接上进行多个并发数据流。

路由表刷新机制：

设计周期性的路由表刷新机制，以保持路由表的最新状态。可以使用Kademlia DHT中的桶刷新算法。
设计节点剔除策略，如根据节点活跃度、信誉等指标剔除不活跃或恶意节点。


数据传输与消息广播：

使用libp2p中的PubSub系统进行消息广播。可以选择Gossipsub或Floodsub作为PubSub实现。
使用libp2p的Bitswap协议进行点对点数据传输，允许节点之间直接请求和共享数据。
安全性与隐私：

使用libp2p中的Noise或TLS协议实现安全传输层。
根据需要实现隐私功能，如加密通信、匿名路由等。
最大连接数和资源管理：

设计最大连接数限制，防止节点资源耗尽。可以在ConnManager中实现此功能。
使用流量控制策略，如令牌桶算法，确保节点间数据传输的稳定性。
设计资源管理策略，如内存、CPU使用率限制，防止节点资源耗尽


网络拥塞与延迟：在P2P网络中，由于节点数量的增加，可能会出现网络拥塞和延迟问题。

解决方法：

优化路由算法，选择最佳路径进行数据传输。
引入激励机制，鼓励节点提供更多带宽资源。
实现自适应流量控制策略，根据网络条件动态调整传输速率。
不稳定节点：由于P2P网络中的节点可能随时加入或离开网络，节点的稳定性可能会受到影响。

解决方法：

引入节点评级机制，根据节点的稳定性、性能和信誉等指标为节点评级。
优先与高评级节点建立连接，提高网络稳定性。
节点隔离：在P2P网络中，可能会出现部分节点被隔离的情况，导致网络分裂。

解决方法：

引入多种节点发现机制，增加节点互联的可能性。
设计自愈算法，当检测到网络分裂时，自动触发网络修复操作。
恶意节点：P2P网络中可能存在恶意节点，试图攻击网络或进行欺诈行为。

解决方法：

引入节点信誉体系，记录节点的行为并为其评分。
对恶意节点采取惩罚措施，如降低其评分或将其踢出网络。
加强安全机制，防止恶意节点篡改数据或发起攻击。
数据一致性：在P2P网络中，需要确保所有节点间的数据一致性。

解决方法：

使用分布式哈希表（DHT）或其他分布式存储技术来存储和同步数据。
设计有效的数据同步和校验机制，确保节点间的数据一致性。
可扩展性：随着节点数量的增加，P2P网络的可扩展性可能会受到挑战。

解决方法：

引入分片技术，将网络划分为多个子网络，提高整体处理能力和扩展性。
优化路由算法，提高网络搜索和数据传输的效率。

网络拓扑优化：

设计层次化的网络拓扑结构，将节点划分为不同层次，如超级节点、普通节点等。
超级节点可以负责维护网络的稳定性、存储关键数据和协调其他节点。
普通节点可以负责处理局部数据和参与局部共识。
设计拓扑优化算法，如节点聚类、最小生成树等，以提高网络传输效率。
网络编码技术：

引入网络编码技术，如Fountain Codes、Random Linear Network Coding等，以提高数据传输的鲁棒性和效率。
网络编码可以将数据分片并添加冗余信息，使得接收者可以从   部分数据片段中恢复原始数据，从而降低数据丢失的影响。
网络监控与分析：

设计网络监控与分析工具，实时收集网络中的各种指标，如节点状态、连接数、带宽使用率、延迟等。
使用数据可视化技术，将收集到的指标展示为图表，便于分析和诊断网络问题。
设计自动告警机制，当网络出现异常时，自动触发告警通知相关人员。
跨链互操作性：

为了实现不同P2P网络之间的互操作性，可以设计跨链通信协议，使得不同网络中的节点可以互相传输数据和共享资源。
跨链通信协议可以基于现有的跨链技术，如Cosmos、Polkadot等，或者根据实际需求开发新的跨链协议。
应用层协议设计：
在P2P网络的基础上，可以设计各种应用层协议来满足不同应用场景的需求，如文件传输协议、实时通信协议等。
应用层协议需要考虑数据的可靠性、实时性、安全性等因素，以满足不同应用的需求。
容错与恢复机制：
设计容错与恢复机制，以应对网络中的各种故障，如节点宕机、数据丢失等。
容错机制可以包括数据备份、故障检测、故障隔离等。
恢复机制可以包括数据恢复、节点重启、网络重组等。

## 跨层次网路通信设计
设计跨层次通信协议的目标是实现普通节点和验证节点之间的高效通信。以下是一个基于这个目标的详细跨层次通信协议设计：

协议结构：

定义一个模块化的协议结构，将协议分为不同的子协议以处理不同类型的通信需求。例如，可以设计子协议来处理交易传播、状态同步、共识消息等。
消息格式：

设计一种通用的消息格式，以便在普通节点和验证节点之间传输各种类型的数据。消息格式应具有以下特性：
可扩展：支持添加新的消息类型和字段，以满足未来需求。
紧凑：尽量减小消息大小，以降低网络传输开销。
可读：易于解析和处理，同时具有一定的自描述能力。
可以考虑使用现有的序列化格式，如Protocol Buffers、MessagePack等，或者设计自定义的消息格式。
传输层协议选择：

选择合适的传输层协议，以满足跨层次通信的性能和可靠性需求。可能的选择包括：
TCP：提供可靠的数据传输，适用于需要确保数据完整性的场景，如状态同步。
UDP：提供低延迟的数据传输，适用于实时通信场景，如共识消息传播。
可以根据实际需求选择单一传输层协议，或者同时使用多种协议。
身份验证和安全通信：

为了确保通信安全，需要在普通节点和验证节点之间建立身份验证和安全通信机制。可以采用以下方法：
使用公钥基础设施（PKI）对节点进行身份验证。
使用安全的传输层协议，如TLS，以加密通信数据并防止窃听和篡改。
数据同步策略：

设计数据同步策略，以便普通节点和验证节点能够高效地同步状态和交易数据。可能的策略包括：
增量同步：仅同步自上次同步以来的新数据，以减小传输开销。
分片同步：将数据划分为多个片段，并允许节点仅同步感兴趣的片段。
延迟同步：对于低优先级的数据，可以延迟同步以减轻网络负载。
负载均衡和路由优化：

实现负载均衡和路由优化机制以确保跨层次通信的高效性和可靠性。以下是一些可能的方法：

多路径传输：

使用多路径传输技术（如MPTCP），允许普通节点和验证节点通过多个网络路径并行传输数据。这可以提高通信的吞吐量和容错性。
节点选择和连接管理：

设计智能节点选择策略，使普通节点优先连接到性能良好、信誉高的验证节点。同时，实现连接管理机制，动态调整连接数量和质量，以优化通信性能。
消息广播策略：

设计消息广播策略，以实现快速、可靠的消息传播。例如，可以使用随机行走（Random Walk）或者环状波浪（Ripple）算法等策略，根据网络拓扑和节点性能调整消息传播路径。
消息缓存和重传机制：

为了确保消息的可靠传输，实现消息缓存和重传机制。例如，节点可以在收到确认消息之前缓存已发送的消息，并在消息丢失或超时时进行重传。
消息优先级和排队策略：
根据消息的类型和紧急程度，为消息分配优先级，并实现相应的排队策略。例如，可以优先传输共识消息和高价值交易，而将低优先级的状态同步请求延迟处理。
流量控制和拥塞避免：
实现流量控制和拥塞避免机制，以确保通信的稳定性和高效性。例如，可以使用滑动窗口（Sliding Window）或者令牌桶（Token Bucket）等算法，根据网络状况动态调整发送速率。




##  根据验证节点优先相连，还能和普通节点连接
DHT（分布式哈希表）通常根据哈希值距离来建立连接。要实现让验证节点保持紧密连接，可以采用以下策略：

基于角色的分布式哈希表（R-DHT）：

在原始DHT的基础上引入角色概念，将网络中的节点分为验证节点和普通节点。设计一个角色敏感的哈希函数，使验证节点在DHT中更有可能彼此靠近。这样，在查找和建立连接时，验证节点将更容易找到并连接到其他验证节点。




验证节点专属子网络：

在整个P2P网络中为验证节点创建一个子网络。验证节点加入子网络后，会优先与其他子网络中的验证节点建立连接。子网络可以使用与主网络相同或不同的DHT实例。为了让验证节点还能连接普通节点，可以允许它们在子网络外部与普通节点建立一定数量的连接。

分层网络结构：

设计一种分层网络结构，将验证节点分布在网络的上层，普通节点分布在下层。在这种结构下，上层验证节点会优先与其他验证节点建立连接，形成紧密连接。同时，验证节点还可以与下层普通节点建立连接。
混合拓扑策略：

结合结构化（如DHT）和非结构化（如随机图）拓扑技术，设计一种混合拓扑策略。验证节点之间使用非结构化拓扑建立紧密连接，而与普通节点之间使用结构化拓扑进行通信。这样，验证节点可以在保持紧密连接的同时与普通节点建立连接。
以上策略可以帮助实现验证节点间的紧密连接，同时允许验证节点与一定数量的普通节点建立连接

## 为了实现验证节点间的快速共识消息传输，可以采用以下网络拓扑和消息广播策略：

优先连接验证节点：实现基于角色的连接策略，使验证节点在连接到其他验证节点时具有更高的优先级。这将确保验证节点之间紧密相连，有利于快速传	播共识消息。

子网络拓扑：在整个P2P网络中为验证节点创建一个子网络。验证节点加入子网络后，会优先与其他子网络中的验证节点建立连接。可以使用gossip协议或其他类似协议来实现子网络中的消息传播。为了让验证节点还能连接普通节点，可以允许它们在子网络外部与普通节点建立一定数量的连接。

消息广播策略：采用gossip协议进行消息广播。在gossip协议中，节点之间会定期交换信息，每个节点收到一条新消息后会将其转发给其他已连接的节点。这种方式可以确保消息在验证节点间快速传播。为了降低消息传播延迟，可以采用以下策略：

优先转发共识消息：在处理接收到的消息时，优先处理和转发共识相关的消息。
限制消息的转发次数：为了避免消息在网络中过度传播，可以为每条消息设置一个最大转发次数。当转发次数达到限制时，节点将不再转发该消息。
使用消息缓存：为了避免重复转发相同的消息，可以在每个节点上维护一个消息缓存。当接收到一条已经在缓存中的消息时，节点将不再转发该消息。
跨层次通信：为了让验证节点与普通节点之间也能进行有效的通信，可以实现跨层次通信协议。在这种协议中，验证节点会将部分共识消息广播给普通节点，让普通节点了解到共识状态的变化。同时，普通节点也可以向验证节点发送交易和查询请求。

通过这些网络拓扑和消息广播策略的组合，可以实现验证节点间的快速共识消息传输，同时确保验证节点与普通节点之间的有效通信。请注意，这里给出的设计仅供参考，实际实现可能需要根据您的网络需求和设计进行调整。