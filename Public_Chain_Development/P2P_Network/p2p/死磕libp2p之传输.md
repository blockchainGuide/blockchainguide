# listen&dial

## 通用传输接口

传输是根据两个核心操作来定义的，即监听和拨号。

侦听意味着您可以使用传输实现提供的任何功能来**接受来自其他对等方的传入连接**。例如，unix平台上的TCP传输可以使用绑定和侦听系统调用，让操作系统将给定TCP端口上的流量路由到应用程序。

拨号是打开与侦听对等方的传出连接的过程。与监听一样，具体内容由实现决定，但libp2p实现中的每个传输都将共享相同的编程接口。

## 地址

在建立对peer的拨号连接之前，我们需要知道如何访问这些peer。由于每种传输方式会有其独特的寻址方案，因此libp2p采用了一种称为“Multiaddress”或“Multiaddr”的协议来编码许多不同的寻址方案。

下面是一个针对TCP/IP传输的Multiaddr示例：

```markdown
/ip4/198.51.100.0/tcp/6543
```

这与更常见的“198.51.100.0: 6543”写法是等价的，但它具有显式说明所涉及协议的优势。通过Multiaddr，您可以一目了然地看出198.51.100.0地址属于IPv4协议，而6543则属于TCP协议

“dial”和“listen”都涉及Multiaddress。在**监听时，您向传输层提供您要监听的地址**，在**拨打对等端时，则需要提供将要拨打的地址**。

在拨打远程对等节点时，Multiaddress应包括您想要连接的对等节点的Peer ID。这使libp2p能够建立安全通信通道并防止身份伪装。

下面是一个包含Peer ID的Multiaddress示例：

```markdown
/ip4/192.0.2.0/tcp/4321/p2p/QmcEPrat8ShnCph8WjkREzt5CPXF2RwhYxYBALDcLC1iV6
```

其中的“/p2p/QmcEPrat8ShnCph8WjkREzt5CPXF2RwhYxYBALDcLC1iV6”组件使用公钥的哈希唯一地标识了远程对等节点

## 支持多个传输

libp2p应用程序**通常需要同时支持多个传输方式**。例如，您可能希望您的服务可以通过TCP从长时间运行的守护进程使用，同时也可以接受来自在Web浏览器中运行的对等节点的WebSocket连接。

负责管理多种传输方式的libp2p组件称为“switch”，它还协调协议协商、流多路复用、建立安全通信以及其他形式的“连接升级”。

switch提供了单个“入口点”进行拨号和监听，使您的应用程序代码无需担心特定的传输方式和其他底层使用的“连接堆栈”组件。

可以将它看作是一个高级接口，可以让我们更轻松地编写支持多种传输方式的复杂应用程序，并且无需深入了解底层实现细节

# QUIC

QUIC是一种新的传输协议，它提供了一种建立在UDP之上的始终加密的流复用连接

## TCP关键挑战

Head-of-line blocking (HoL)：当一个数据包在传输过程中被丢失时，后续的数据包需要等待该数据包重传后才能被传输，这样就导致了传输的阻塞。因为TCP是基于**字节流**传输的，数据包之间没有明确的边界，所以即使只有一个数据包丢失，后面的数据也需要等待该数据包的重传，这样就会导致后面的数据包无法及时到达接收方，从而增加了延迟和拥塞。

Ossification：由于TCP的协议头不加密，中间节点可以检查和修改TCP协议头字段，当它们遇到任何不理解的字段时可能对TCP协议破坏，这使得更改TCP协议的任何线路格式变得几乎不可能。

握手效率低下：TCP花费一次网络往返时间（RTT）来验证客户端的地址。只有在此之后，TLS才能开始密码握手，再消耗一次RTT。因此，建立加密连接始终需要两个RTTs。

QUIC的设计考虑了以下目标：

- 流传输不会导致Head-of-line blocking (HoL)问题，因为在流传输中，数据是被划分为**多个数据流**（stream）并独立传输的。每个数据流都有自己的编号，并且数据包里面带有数据流的编号信息，接收方可以根据数据流的编号把数据包放到正确的数据流中，从而避免了传输过程中的Head-of-line blocking问题

- 将连接建立的延迟时间**降至单个RTT**，以允许为恢复的连接发送零RTT应用程序数据。

- 尽可能加密。这消除了ossification的风险，因为中间节点无法读取任何加密的字段。

## QUIC怎么工作的

它不是基于TCP构建，而是基于UDP构建。当一个UDP数据包丢失时，内核不会自动重传数据包。因此，QUIC负责自行检测和修复丢失的数据包。通过使用加密，QUIC避免了中间节点的强制陈旧。TLS 1.3握手在首个数据包包中完成，省去了验证客户端地址的成本并节省一个RTT。此外，QUIC还暴露多个数据流（而不仅仅是单字节流），因此应用层不需要流多路复用器。部分应用层也直接构建在QUIC中。

此外，当客户端已经与某个服务器通信过，可以在后续连接中利用QUIC的0 RTT功能。客户端可以在QUIC握手完成之前就发送（加密的）应用数据

## QUIC本机多路复用

一个QUIC数据包可以携带来自一个或多个数据流的帧所包含的流数据。由于即使乱序接收，QUIC数据包也可以被解密，这解决了流多路复用器应用于TCP连接时遇到的Head-of-line阻塞问题：如果包含某个流的流数据的数据包丢失，这只会阻塞该流的进展，而所有其他流仍然可以继续前进。

## libp2p中的QUIC

libp2p仅支持双向数据流，同时默认使用TLS 1.3。由于QUIC已经提供了加密的流多路复用连接，libp2p直接使用QUIC数据流，无需任何额外的框架。

为了认证各自的对等方ID，节点将自己的对等方ID编码到一个自签名证书中，并使用主机的私钥签名。这与libp2p TLS握手中对等方ID进行认证的方式相同。



