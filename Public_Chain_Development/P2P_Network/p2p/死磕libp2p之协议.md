# libp2p协议

## 协议ID

ibp2p协议具有唯一的字符串标识符，这些标识符在首次打开连接时用于协议协商过程

> /my-app/amazing-protocol/1.0.1

如果有重大更改，会产生新的版本号。

## 处理函数

当传入流被标记为注册的协议 ID 时，将调用对应的处理函数。

## 二进制流

libp2p 协议传输的“介质”是具有以下属性的双向二进制流：

- 每一方都可以**随时从流中读取和写入**
- 数据的**读取顺序与写入顺序相同**
- 可以是“半封闭”，即写封闭读开，或者读封闭写写

libp2p 还将确保流的[安全](https://docs.libp2p.io/concepts/secure-comms/)和高效 [多路复用](https://docs.libp2p.io/concepts/stream-multiplexing/)。这对协议处理程序是透明的，协议处理程序通过流读取和写入未加密的二进制数据。

二进制数据的格式以及何时以及由谁发送什么的机制都由协议决定。

## 协议协商

当 dial out 以启动新的流时，libp2p将发送您想要使用的协议的协议id。另一端的监听peer将根据注册的协议处理程序检查传入的协议id。

如果不支持请求的协议，它将结束流，并且拨号peer可以使用不同的协议重试，或者可能使用最初请求的协议的回退版本。

如果支持该协议，则侦听对等方将回显协议id，作为将来通过流发送的数据将使用商定的协议语义的信号。

这种就给定流或连接使用什么协议达成一致的过程称为协议协商。

## 协议匹配

- 通过协议ID匹配
- 协议ID没有确切的匹配，模糊匹配

## dial 特定协议

当拨号给远程Peer以打开新流时，发起对等端会发送他们想要使用的协议id。远程对等方将使用上述匹配逻辑来接受或拒绝该协议。如果协议被拒绝，拨号对等方可以重试。

拨号时，您可以选择提供一个**协议id列表**，而不是单个id。当您提供多个协议id时，将依次尝试每个协议id，如果远程对等方至少支持其中一个协议，则将使用第一个成功匹配。拨号端可以回退到和远程端匹配的版本。

## 核心libp2p协议

### 常见模式

下面描述的协议都使用协议缓冲区（又名protobuf）来定义消息模式。

消息是使用一个非常简单的约定通过有线进行交换的，该约定在二进制消息payload前面加一个整数，该整数表示**有效载荷的长度**（以字节为单位）。长度被编码为protobuf-variant（可变长度整数）。

### ping 

> /ipfs/ping/1.0.0

ping协议是一种简单的活跃度检查，对等方可以使用它来快速查看另一个对等方是否在线。

在初始协议协商之后，拨号对等方发送**32字节的随机二进制数据**。监听对等端回显数据，拨号对等端将验证响应并测量请求和响应之间的延迟。

### identify

> /ipfs/id/1.0.0

识别协议允许对等方交换关于彼此的信息，尤其是它们的公钥和已知网络地址。

基本识别协议通过使用上表中所示的识别协议id建立到对等端的新流来工作。

当远程对等端打开新的流时，他们将填写一条Identify protobuf消息，其中包含关于他们自己的信息，例如他们的公钥，该公钥用于派生他们的对等端ID。

重要的是，Identify消息包括一个observedAddr字段，该字段包含对等方观察到请求的多地址。这有助于对等方确定其NAT状态，因为它允许他们查看其他对等方观察的公共地址，并将其与自己的网络视图进行比较。

在P2P网络中，对等方可能被部署在不同的网络中，包括NAT（网络地址转换）网络。NAT网络中的设备无法直接访问来自外部网络的数据包，因为它们被阻止或者重定向到本地网络。为了克服这种情况，对等方需要在网络上建立一个多地址视图，以便其他对等方了解它们的公共地址。观察到请求的多地址可以让对等方更好地理解自己的网络情况，并比较其视图与其他对等方观察到的公共地址之间的差异。这有助于对等方更好地了解其NAT状态，并更好地管理其网络资源

### identify/push 

与identify略有不同，identify/push 协议发送相同的identify消息，但它是主动发送的，而不是响应请求。

如果对等端开始监听新地址，建立新的中继电路，或者使用标准identify协议从其他对等端获悉其公共地址，这是有用的。在创建或获悉新地址后，对等方可以将新地址推送给其当前知道的所有对等方。这样可以使每个人的路由表保持最新，并使其他对等方更有可能发现新地址

## Circuit Relay

> /libp2p/circuit/relay/0.1.0

libp2p提供了一种协议，用于在两个对等体无法直接连接时通过中继对等体隧道传输流量。
