## DEX

去中心化交易所是指使用智能合约，部署在区块链运行的非托管式交易所， 用户无需托管资产在第三方，且无惧服务器宕机。

## AMM

AMM，全称是 Automated Market Maker，即自动做市商。它是一种针对区块链去中心化交易所（DEX）的市场交易模型，通过智能合约自动匹配交易对的供需，平衡交易池中的资产，从而提供流动性，保证交易顺畅。

在传统中心化交易所（CEX）中，市场交易由人工撮合，即交易员/做市商在深度盘口挂单，通过人工调整价格实现市场做市，因此需要大量的资金和人力成本，同时容易出现市场操纵等不公平情况。而在 DEX 中，由于没有中心化的撮合者，价格由 AMM 算法计算得出，因此成交量更加分散，交易持久且可扩展。

## CPMM

CPMM 全称是 Constant Product Market Maker，即常数乘积自动做市商，是 AMM 自动做市商策略中最常用的一种。常数乘积自动做市商主要用于提供去中心化交易所中的流动性，允许用户在不需要中心化交易所或第三方市场制造商的情况下，在智能合约中交换代币。

CPMM 原理：

在 CPMM 策略中，通过将两个代币的数量相乘得到一个常数 K。例如，我们有代币 A 和代币 B，并且假设 K = A * B。在交易开始之前，投资者需要将代币 A 或 B 存入交易池，以便启动代币 A 和代币 B 之间的交易。当交易发起时，交易池中的代币数量将会发生变化，并自动平衡交易池，使得 K 的值不变。

CPMM例子：

1. 甲在 Uniswap-v2 上提供了 1000 个 TokenA 和 100 个 TokenB 作为流动池，计乘数 Kab = 1000 * 100 = 100000
2. 乙想要在 Uniswap-v2 上使用 100 个 TokenA 兑换 TokenB，那么 Uniswap-v2 会首先计算交易后流动池会有 1000 + 100 = 1100 个 TokenA；为了维持 Kab 的不变，就需要 TokenB 的数量减少为 100000/1100 = 90.909... 。因此，Uniswap-v2 会给乙兑换出100 - 90.909 = 9.091 个 TokenB 。
3. 乙成功地使用 100 个 TokenA 在 Uniswap-v2 上兑换了 9.091 个 TokenB。可以预见的是，根据这套算法，乙需要兑换的 TokenA 越多，平均每个 TokenA 能兑换的 TokenB 就会越少。这就产生了滑点的概念。

简化公式：(TokenA余额 + 你出售的TokenA)*(TokenB余额 - 你获得的TokenB) = 常数K

CPMM 的优点：

1. 高流动性：因为交易池总是保持到常数K的分布，它可以提供高流动性来满足市场需求并保持更准确的价格。
2. 无偏差市场：CPMM 可以在没有做市商的情况下建立市场，这可以消除做市商为实现个人利益而改变市场条件的可能性。
3. 经济效率：CPMM 是高效的，因为它并不需要市场搜寻者来进行交易和价格发现，从而降低了交易成本。

CPMM 的缺点：

1. 容易受到大单影响：当一个用户试图使用大序列交易量涵盖一定比例的池子时，交易相应地通知了池子协议这个方向上依赖的比例。这会导致池子协议增加对该方向上的滑移保护。这在所谓的 "闪电贷款" 中被利用，从而大规模漏洞。
2. 价格随供求变化：假设有一些应用程序只需要代币 A。这些应用程序将使用代币 A 从交易池中提取更多的代币 A，以最小的价格成本获得代币。这会降低代币 A 在交易池中的供应，并增加代币的价格。如果代币 B 的需求不再增加，则代币 A 的价格会反弹回到以前的水平。

## 滑点

由于Uniswap V2的价格公式是基于流动性池中的代币数量的，所以当一个大额交易发生时，池中的代币数量会发生显著变化，从而导致价格波动。这种价格波动就是滑点。通常来说，交易量越大，滑点也越大。

假设流动性池中有100个ETH和20,000个USDC，你打算用1个ETH购买USDC。在交易开始之前，预期的交易价格是：

100 * 20,000 = k
k = 2,000,000

现在，假设在你发起交易的同时，有一个大额交易者用50个ETH购买USDC。首先，我们来计算大额交易者的交易会如何影响流动性池。将50个ETH加入流动性池后，池中的ETH储备将增加到150个。我们需要计算池中USDC的新储备数量y'：

150 * y' = 2,000,000

解方程得到y' ≈ 13333。这意味着池中USDC的储备将减少到13333个。大额交易者获得的USDC数量为20,000 - 13,333 = 6,667个。

由于这个大额交易，流动性池的代币数量发生了显著变化。现在，你的交易将基于更新后的流动性池进行。池中的ETH储备已经增加到150个，USDC储备减少到13,333个。根据新的代币数量，你的预期交易价格如下：

150 * 13,333 = k'
k' = 2,000,000

在这个新的流动性池中，你用1个ETH购买USDC。将1个ETH加入流动性池后，池中的ETH储备将增加到151个。我们需要计算池中USDC的新储备数量y''：

151 * y'' = 2,000,000

解方程得到y'' ≈ 13234。这意味着池中USDC的储备将减少到13234个。你本次交易可以获得约99个USDC（13,333 - 13,234）。

与最初预期的198个USDC相比，你实际获得的USDC数量显著减少。这是因为大额交易对流动性池中代币数量的影响。滑点可以表示为：

滑点 = (预期获得的USDC - 实际获得的USDC) / 预期获得的USDC
滑点 = (198 - 99) / 198 ≈ 0.50 或 50%

在这个例子中，由于其他人的超级大额交易，你的滑点增大到50%。为了防止在这种情况下发生损失，你可以设置一个滑点容忍度。例如，如果你设置了5%的滑点容忍度。

## 流动性池

流动性池是一个去中心化交易所（如Uniswap V2）中用于支持交易的代币池。每个流动性池包含两种代币，例如ETH和USDC。流动性池的目的是为交易提供流动性，使用户能够在交易平台上轻松兑换不同的代币。流动性池的大小决定了交易平台的流动性。池中代币数量越多，流动性越好，滑点就越低。

不同于传统中心化交易所的订单交易，可以理解为有一个和你博弈的对手，你需要买入他卖出的单子，或者等他吃掉你卖出的单子。不管买入还是卖出，在 Uniswap-v2 上的所有交易都是对流动池的交易，没有对手会直接和你做交易。

## 流动性凭证LP

为了向流动性池注入资金，用户可以成为流动性提供者（LP）。当用户向某个交易对的流动性池注入资金时，他们会获得与其贡献比例相等的流动性凭证。流动性凭证是一种代表用户在**流动性池中份额**的代币。

流动性凭证的作用是跟踪流动性提供者的份额，并在提取流动性时用于兑换原始资产。此外，流动性提供者还可以根据持有的流动性凭证份额获得交易手续费收益

## 无常损失

无常损失（Impermanent Loss）是去中心化金融（DeFi）领域中的一个重要概念，它是指流动性提供者（LP）在向去中心化交易所（如Uniswap）提供流动性时可能面临的损失。当流动性池中的代币价格发生波动时，流动性提供者可能会遭受无常损失。

无常损失的主要原因在于流动性池的自动做市机制。在去中心化交易所中，交易双方通过流动性池进行代币交换。为保持流动性池中两种代币的乘积恒定（即xy=k，其中x和y分别表示池中两种代币的数量，k为恒定值），流动性池的价格会随市场价格波动而自动调整。

当一个代币的价格相对于另一个代币上涨时，交易者会倾向于购买价格上涨的代币。这将导致流动性池中价格上涨的代币数量减少，而价格相对较低的代币数量增加。换句话说，流动性提供者将获得更多的价格较低的代币和更少的价格较高的代币。当流动性提供者将其流动性凭证兑换回原始资产时，他们可能获得的价值低于直接持有这些代币的价值。这就是无常损失。

我们用一个简化的例子来说明无常损失：

假设 Alice 决定为一个去中心化交易所（如 Uniswap）中的 ETH/USDC 交易对提供流动性。初始时，1 个 ETH 的价格等于 2,000 USDC。Alice 投入了 1 个 ETH 和 2,000 个 USDC 到流动性池中。

现在，我们假设 ETH 的价格开始上涨。价格上涨到 4,000 USDC 时，其他用户在 Uniswap 上购买 ETH，导致流动性池中 ETH 的数量减少，而 USDC 的数量增加。假设在这个新价格下，流动性池的组成变为 0.6 个 ETH 和 3,200 个 USDC。

如果 Alice 此时决定从流动性池中提取资产，她将获得 0.6 个 ETH 和 3,200 个 USDC（假设她是唯一的流动性提供者）。将这些资产换算成 USDC 的价值，总价值为 0.6 * 4,000 + 3,200 = 5,600 USDC。

然而，如果 Alice 最初直接持有这些代币（1 个 ETH 和 2,000 个 USDC），在 ETH 价格上涨到 4,000 USDC 时，她的总价值将为 1 * 4,000 + 2,000 = 6,000 USDC。

这意味着 Alice 的无常损失为 6,000 - 5,600 = 400 USDC。这种损失是因为流动性池中代币价格的变动，导致 Alice 在退出流动性池时获得了相对较多的 USDC，而相对较少的 ETH。在这个例子中，无常损失使 Alice 的投资回报受到了影响。

需要注意的是，在实际情况中，无常损失可能会被交易手续费收益抵消。此外，当市场价格恢复到 Alice 加入流动性池时的初始价格时，无常损失将消失。因此，在评估无常损失时，需要考虑价格波动、交易手续费收益等多种因素。

以下是减轻无常损失的一些建议：

1. 提供流动性的时间：如果你相信市场价格波动可能是暂时的，可以选择在价格波动较小的时期提供流动性。这可以降低无常损失的风险。

2. 选择稳定币交易对：流动性池中的代币对价格波动越小，无常损失的风险就越低。投资稳定币交易对（如USDC/DAI）可以降低无常损失的风险，因为稳定币之间的价格波动较小。

3. 平衡风险和收益：在选择流动性池时，权衡无常损失风险和潜在收益。考虑流动性池的交易量、交易手续费和流动性挖矿奖励。这些收益可能会抵消无常损失，使提供流动性更具吸引力。

4. 使用新型自动做市商（AMM）协议：部分新型AMM协议（如Balancer、Curve等）尝试通过优化价格曲线和调整代币权重等方式减轻无常损失。在选择流动性池时，了解不同协议的优缺点并选择适合你的投资策略的协议。

总之，无常损失是流动性提供者需要了解和评估的风险之一。在成为流动性提供者之前，确保充分了解市场价格波动、交易手续费收益和潜在的流动性挖矿奖励，以便在风险和收益之间找到合适的平衡。

## 价格预言机

Uniswap V2 的价格预言机并不是一个独立的机制或服务，而是基于 Uniswap V2 的一种技术实现，用于获取交易对的近似价格。这种实现利用了 Uniswap V2 流动性池的特性来提供一个去中心化的、相对稳定的价格参考。

价格预言机的原理如下：

1. 固定区间的时间加权平均价格（TWAP）：为了避免价格操控，价格预言机使用一个短时间内的加权平均价格，而不是直接从流动性池获取瞬时价格。这种方法称为时间加权平均价格（TWAP），它可以在一定程度上降低瞬时价格波动的影响，从而提供一个更稳定的价格参考。

2. 存储每个区块的累积价格：Uniswap V2 在每个区块的流动性池合约中存储累积价格。这些累积价格是从流动性池创建以来每个区块中的价格之和。通过比较两个不同区块的累积价格，可以计算出这两个区块之间的平均价格。

3. 计算 TWAP：要计算某个时间区间内的 TWAP，首先从两个不同区块（例如，当前区块和 n 个区块之前的区块）获取累积价格，然后计算这两个累积价格之差。接着，将差值除以区块数量（n），得到这段时间内的平均价格。

例如，假设我们想要计算过去 5 个区块内 ETH/USDC 交易对的 TWAP。我们需要从当前区块（如区块 100）和 5 个区块之前（如区块 95）的累积价格中获取数据。假设区块 100 的累积价格为 500,000，区块 95 的累积价格为 475,000。那么，这 5 个区块内的平均价格为 (500,000 - 475,000) / 5 = 5,000。

总之，Uniswap V2 的价格预言机是一种基于 Uniswap V2 流动性池的技术实现，用于提供去中心化的、相对稳定的价格参考。通过计算固定区间内的时间加权平均价格（TWAP），价格预言机可以降低瞬时价格波动的影响，并提供一个更可靠的价格信息。虽然这种方法并非完全防操控，但它仍然为去中心化金融（DeFi）应用提供了一个相对稳定的价格来源。

尽管 Uniswap V2 的价格预言机在许多情况下都能提供可靠的价格信息，但对于某些需要更高安全性和准确性的应用，可能需要使用其他价格预言机服务，如 Chainlink 等去中心化预言机网络。这些去中心化预言机网络通常从多个不同的数据来源聚合价格信息，并利用加密经济激励机制确保数据的安全性和准确性。

